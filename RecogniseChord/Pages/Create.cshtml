@page
@model CreateModel
@{
    ViewData["Title"] = "Побудувати акорд";
}

<div class="text-center">
    <h1 class="display-4">Побудувати акорд</h1>
    <div class="innercontainer">
        <div id="rightcontainer" class="halfcontainer">
            <form method="post" asp-page-handler="Count" id="countForm">
                <p>Кількість звуків?</p>
                @foreach (var c in Model.CountOptions)
                {
                    if (Model.SelectedCount.ToString() == c)
                    {
                        @:<label class="me-2"><input type="radio" name="SelectedCount" value="@c" checked /> @c</label>
                    }
                    else
                    {
                        @:<label class="me-2"><input type="radio" name="SelectedCount" value="@c" /> @c</label>
                    }
                }
                <input type="hidden" asp-for="RootNote" />
            </form>

            <form method="post" asp-page-handler="Type" id="typeForm">
                <div class="mt-3">
                    <label>Тип:</label>
                    <select asp-for="SelectedType" onchange="document.getElementById('typeForm').submit();">
                        <option value="">--</option>
                        @foreach (var t in Model.TypeOptions)
                        {
                            if (Model.SelectedType == t)
                            {
                                @:
                                <option value="@t" selected>@t</option>
                            }
                            else
                            {
                                @:
                                <option value="@t">@t</option>
                            }
                        }
                    </select>
                </div>
                <input type="hidden" asp-for="SelectedCount" />
                <input type="hidden" asp-for="RootNote" />
            </form>

            <form method="post" asp-page-handler="Quality" id="qualityForm">
                <div class="mt-3">
                    <label>Якість:</label>
                    <select asp-for="SelectedQuality" onchange="document.getElementById('qualityForm').submit();">
                        <option value="">--</option>
                        @foreach (var q in Model.QualityOptions)
                        {
                            if (Model.SelectedQuality == q)
                            {
                                @:
                                <option value="@q" selected>@q</option>
                            }
                            else
                            {
                                @:
                                <option value="@q">@q</option>
                            }
                        }
                    </select>
                </div>
                <div class="mt-3">
                    <label>Корінь:</label>
                    <select asp-for="RootNote" onchange="document.getElementById('qualityForm').submit();">
                        @foreach (var r in Model.RootOptions)
                        {
                            if (Model.RootNote == r)
                            {
                                @:
                                <option value="@r" selected>@r</option>
                            }
                            else
                            {
                                @:
                                <option value="@r">@r</option>
                            }
                        }
                    </select>
                </div>
                <input type="hidden" asp-for="SelectedCount" />
                <input type="hidden" asp-for="SelectedType" />
            </form>

            <div class="mt-4">
                <button id="playBtn" type="button" class="btn btn-success" disabled>Відтворити</button>
                <audio id="chordAudio" preload="auto"></audio>
                <input type="hidden" id="generatedRel" value="@Model.GeneratedFileRelative" />
            </div>
        </div>
        <div id="leftcontainer" class="halfcontainer">
            @if (Model.CanPlay)
            {
                <p>Файл створено: <code>@Model.GeneratedFileRelative</code></p>
                <p>Акорд: @Model.SelectedType @Model.SelectedQuality (@Model.RootNote)</p>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // submit count form on radio change
        document.querySelectorAll('#countForm input[type=radio]').forEach(r => {
        r.addEventListener('change', () => {
        document.getElementById('countForm').submit();
        });
        });

        document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('playBtn');
        const audio = document.getElementById('chordAudio');
        const hidden = document.getElementById('generatedRel');

        function refreshAudio() {
        const rel = hidden.value;
        if (rel && rel.trim() !== '') {
        audio.src = rel;
        try { audio.load(); } catch(e) { console.error(e); }
        btn.disabled = false;
        } else {
        audio.removeAttribute('src');
        btn.disabled = true;
        }
        }

        refreshAudio();

        btn.addEventListener('click', () => {
        try {
        audio.pause();
        audio.currentTime =0;
        audio.play();
        } catch(e) { console.error('play error', e); }
        });

        });
    </script>
}
